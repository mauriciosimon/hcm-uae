// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// COMPANY & MULTI-TENANCY
// ============================================================================

model Company {
  id                  String   @id @default(cuid())
  name                String
  nameAr              String?
  tradeLicenseNumber  String?
  establishmentCard   String?
  address             String?
  city                String?
  emirate             String?
  poBox               String?
  phone               String?
  email               String?
  website             String?
  logoUrl             String?
  wpsEmployerCode     String?
  wpsRoutingCode      String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  users               User[]
  employees           Employee[]
  leaveRequests       LeaveRequest[]
  leaveBalances       LeaveBalance[]
  overtimeEntries     OvertimeEntry[]
  payrollRuns         PayrollRun[]
  documents           Document[]
  loans               Loan[]
  systemSettings      SystemSettings?
  subscription        Subscription?

  @@map("companies")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                  String   @id @default(cuid())
  companyId           String
  email               String   @unique
  passwordHash        String?
  firstName           String
  lastName            String
  role                UserRole @default(EMPLOYEE)
  isActive            Boolean  @default(true)
  lastLogin           DateTime?
  invitedBy           String?
  employeeId          String?  @unique
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee            Employee? @relation(fields: [employeeId], references: [id])
  notificationSettings NotificationSettings?

  @@index([companyId])
  @@map("users")
}

enum UserRole {
  ADMIN
  HR_MANAGER
  MANAGER
  EMPLOYEE
}

// ============================================================================
// EMPLOYEE
// ============================================================================

model Employee {
  id                     String   @id @default(cuid())
  companyId              String
  employeeId             String   // Company-specific employee ID

  // Personal Info
  firstName              String
  lastName               String
  firstNameAr            String?
  lastNameAr             String?
  dateOfBirth            DateTime
  gender                 Gender
  nationality            String
  maritalStatus          MaritalStatus
  email                  String
  phone                  String

  // Address
  addressLine1           String?
  addressLine2           String?
  city                   String?
  country                String?

  // Emergency Contact
  emergencyContactName   String?
  emergencyContactPhone  String?
  emergencyContactRelation String?

  // Employment Info
  department             String
  jobTitle               String
  employmentStartDate    DateTime
  employmentEndDate      DateTime?
  contractType           ContractType
  employmentStatus       EmploymentStatus @default(ACTIVE)
  probationEndDate       DateTime?
  reportingManagerId     String?
  workLocation           String?

  // Compensation
  basicSalary            Decimal  @db.Decimal(12, 2)
  housingAllowance       Decimal  @db.Decimal(12, 2) @default(0)
  transportAllowance     Decimal  @db.Decimal(12, 2) @default(0)
  otherAllowances        Decimal  @db.Decimal(12, 2) @default(0)
  totalPackage           Decimal  @db.Decimal(12, 2)

  // Bank Details
  bankName               String?
  bankAccountNumber      String?
  iban                   String?
  routingCode            String?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  company                Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reportingManager       Employee?       @relation("EmployeeManager", fields: [reportingManagerId], references: [id])
  directReports          Employee[]      @relation("EmployeeManager")
  user                   User?
  leaveRequests          LeaveRequest[]
  leaveBalances          LeaveBalance[]
  overtimeEntries        OvertimeEntry[]
  payrollEntries         PayrollEntry[]
  documents              Document[]
  loans                  Loan[]

  @@unique([companyId, employeeId])
  @@index([companyId])
  @@index([department])
  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum ContractType {
  LIMITED
  UNLIMITED
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  PROBATION
  NOTICE_PERIOD
  TERMINATED
  RESIGNED
}

// ============================================================================
// LEAVE MANAGEMENT
// ============================================================================

model LeaveBalance {
  id                String   @id @default(cuid())
  companyId         String
  employeeId        String
  leaveType         LeaveType
  year              Int
  entitled          Decimal  @db.Decimal(5, 2)
  used              Decimal  @db.Decimal(5, 2) @default(0)
  pending           Decimal  @db.Decimal(5, 2) @default(0)
  carriedOver       Decimal  @db.Decimal(5, 2) @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveType, year])
  @@index([companyId])
  @@index([employeeId])
  @@map("leave_balances")
}

model LeaveRequest {
  id                String      @id @default(cuid())
  companyId         String
  employeeId        String
  leaveType         LeaveType
  startDate         DateTime
  endDate           DateTime
  totalDays         Decimal     @db.Decimal(5, 2)
  reason            String?
  status            LeaveStatus @default(PENDING)
  approvedBy        String?
  approvedAt        DateTime?
  rejectionReason   String?
  attachmentUrl     String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@map("leave_requests")
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  UNPAID
  COMPASSIONATE
  HAJJ
  STUDY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================================================
// OVERTIME TRACKING
// ============================================================================

model OvertimeEntry {
  id                String       @id @default(cuid())
  companyId         String
  employeeId        String
  date              DateTime
  hours             Decimal      @db.Decimal(4, 2)
  overtimeType      OvertimeType
  multiplier        Decimal      @db.Decimal(4, 2)
  hourlyRate        Decimal      @db.Decimal(10, 2)
  amount            Decimal      @db.Decimal(12, 2)
  reason            String?
  status            ApprovalStatus @default(PENDING)
  approvedBy        String?
  approvedAt        DateTime?
  isRamadan         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  company           Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@index([date])
  @@map("overtime_entries")
}

enum OvertimeType {
  REGULAR
  NIGHT
  FRIDAY
  HOLIDAY
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// PAYROLL
// ============================================================================

model PayrollRun {
  id                String        @id @default(cuid())
  companyId         String
  month             Int           // 1-12
  year              Int
  status            PayrollStatus @default(DRAFT)
  totalGross        Decimal       @db.Decimal(14, 2) @default(0)
  totalDeductions   Decimal       @db.Decimal(14, 2) @default(0)
  totalNet          Decimal       @db.Decimal(14, 2) @default(0)
  employeeCount     Int           @default(0)
  processedBy       String?
  processedAt       DateTime?
  wpsFileUrl        String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  company           Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entries           PayrollEntry[]

  @@unique([companyId, month, year])
  @@index([companyId])
  @@map("payroll_runs")
}

model PayrollEntry {
  id                String     @id @default(cuid())
  payrollRunId      String
  employeeId        String

  // Earnings
  basicSalary       Decimal    @db.Decimal(12, 2)
  housingAllowance  Decimal    @db.Decimal(12, 2) @default(0)
  transportAllowance Decimal   @db.Decimal(12, 2) @default(0)
  otherAllowances   Decimal    @db.Decimal(12, 2) @default(0)
  overtimeAmount    Decimal    @db.Decimal(12, 2) @default(0)
  bonus             Decimal    @db.Decimal(12, 2) @default(0)
  commission        Decimal    @db.Decimal(12, 2) @default(0)
  grossSalary       Decimal    @db.Decimal(12, 2)

  // Deductions
  unpaidLeave       Decimal    @db.Decimal(12, 2) @default(0)
  loanDeduction     Decimal    @db.Decimal(12, 2) @default(0)
  advanceDeduction  Decimal    @db.Decimal(12, 2) @default(0)
  otherDeductions   Decimal    @db.Decimal(12, 2) @default(0)
  totalDeductions   Decimal    @db.Decimal(12, 2) @default(0)

  // Net
  netSalary         Decimal    @db.Decimal(12, 2)

  // Days worked
  workingDays       Int        @default(0)
  daysWorked        Int        @default(0)

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  payrollRun        PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee          Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payroll_entries")
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  COMPLETED
  CANCELLED
}

// ============================================================================
// LOANS & ADVANCES
// ============================================================================

model Loan {
  id                String     @id @default(cuid())
  companyId         String
  employeeId        String
  type              LoanType
  amount            Decimal    @db.Decimal(12, 2)
  monthlyDeduction  Decimal    @db.Decimal(12, 2)
  totalInstallments Int
  paidInstallments  Int        @default(0)
  remainingBalance  Decimal    @db.Decimal(12, 2)
  status            LoanStatus @default(ACTIVE)
  reason            String?
  approvedBy        String?
  approvedAt        DateTime?
  startDate         DateTime
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  company           Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@map("loans")
}

enum LoanType {
  LOAN
  ADVANCE
}

enum LoanStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model Document {
  id                String         @id @default(cuid())
  companyId         String
  employeeId        String
  documentType      DocumentType
  documentNumber    String?
  issueDate         DateTime?
  expiryDate        DateTime?
  issuingAuthority  String?
  fileUrl           String?
  status            DocumentStatus @default(ACTIVE)
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  company           Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([employeeId])
  @@index([expiryDate])
  @@map("documents")
}

enum DocumentType {
  PASSPORT
  EMIRATES_ID
  VISA
  LABOR_CARD
  HEALTH_INSURANCE
  DRIVING_LICENSE
  TRADE_LICENSE
  OTHER
}

enum DocumentStatus {
  ACTIVE
  EXPIRED
  PENDING_RENEWAL
  CANCELLED
}

// ============================================================================
// SETTINGS
// ============================================================================

model SystemSettings {
  id                  String   @id @default(cuid())
  companyId           String   @unique
  workingDays         String[] // ['sunday', 'monday', ...]
  weekendDays         String[] // ['friday', 'saturday']
  fiscalYearStartMonth Int     @default(1)
  dateFormat          String   @default("DD/MM/YYYY")
  timeFormat          String   @default("24h")
  currency            String   @default("AED")
  currencySymbol      String   @default("AED")
  timezone            String   @default("Asia/Dubai")
  ramadanModeEnabled  Boolean  @default(false)
  ramadanWorkingHours Int      @default(6)
  regularWorkingHours Int      @default(8)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  company             Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("system_settings")
}

model NotificationSettings {
  id                         String   @id @default(cuid())
  userId                     String   @unique
  emailNotifications         Boolean  @default(true)
  documentExpiryAlertDays    Int[]    @default([90, 60, 30, 7])
  leaveRequestNotifications  Boolean  @default(true)
  leaveApprovalNotifications Boolean  @default(true)
  payrollCompletionAlerts    Boolean  @default(true)
  newEmployeeAlerts          Boolean  @default(true)
  contractExpiryAlerts       Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  // Relations
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Subscription {
  id                  String             @id @default(cuid())
  companyId           String             @unique
  plan                SubscriptionPlan   @default(STARTER)
  status              SubscriptionStatus @default(TRIAL)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  employeeLimit       Int                @default(25)
  monthlyPrice        Decimal            @db.Decimal(10, 2)
  currency            String             @default("AED")
  stripeCustomerId    String?
  stripeSubscriptionId String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  company             Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  billingHistory      BillingHistory[]

  @@map("subscriptions")
}

model BillingHistory {
  id              String        @id @default(cuid())
  subscriptionId  String
  date            DateTime
  description     String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("AED")
  status          PaymentStatus @default(PENDING)
  invoiceUrl      String?
  stripeInvoiceId String?
  createdAt       DateTime      @default(now())

  // Relations
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("billing_history")
}

enum SubscriptionPlan {
  STARTER
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  PAST_DUE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
